<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     Jan 9, 2012 8:18:03 PM                                                        

     playhaven_android    
     Simple build script for Playhaven ANDORID sdk
     We rely upon ant-contrib jar library which is included with this project.
     We parse the current SDK version from the getSDKVersion() method in PHConstants.java.
     
     You must configure the android path to point to the correct SDK version on your system.
     Currently, it defaults to the mac os x path for the newest version.
     
     If you want to include other jar files, you must add <classpath> to the "compile" target.
     
     Make sure that you have the android tool in your path.
     
     samstewart                                                                
     ====================================================================== -->
<project name="playhaven_android" default="playhaven_jar">
    <description>
            Simple build script for Playhaven ANDORID sdk (tacked onto the default android_rules.xml file.
    </description>
	<!-- ############### Android Platform Properties ################ -->
	<property name="android_sdk_version" value="8" />
	<property name="sdk.dir" value="/Applications/eclipse/sdks/android-sdk-mac_x86" />
	<property name="android_lib" value="/Applications/eclipse/sdks/android-sdk-mac_x86/platforms/android-${android_sdk_version}/android.jar" />
	
	<property name="compiled_dest" value="${basedir}/bin/playhaven_compiled" />
	
	<!-- Install the property regex module and other ant-contrib -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	  <classpath>
	    <pathelement location="${basedir}/ant-contrib-0.6.jar"/>
	  </classpath>
	</taskdef>
	
	<!-- Create a jar archive (of only java files) -->
    <target name="playhaven_jar" depends="compile">
        <echo message="Create jar from ${basedir}/src" />
    	
    	<!-- create the jar file *without* the sample app and make sure to overwrite (update=no) -->
    	<jar basedir="${compiled_dest}"
    		destfile="${output_jar}"
    		excludes="**/sampleapp/"
    		update="no"
    	/>
    	
    	<echo message="Saved jar at ${output_jar}" />
    	
    	<echo message="Removing old *.class files" />
    	<delete dir="${compiled_dest}" quiet="true" /> 
    </target>

	<!-- Extract the sdk version from PHConstants.java  -->
	<target name="parse_version">
		<loadfile property="playhaven_version" srcfile="${basedir}/src/com/playhaven/src/common/PHConstants.java" />
		<propertyregex property="playhaven_version"
					   override="true"
					   input="${playhaven_version}"
					   regexp="return +&quot;([[0-9]\.]+)&quot;"
					   select="\1" />
		<property name="output_jar" value="${basedir}/bin/playhaven-${playhaven_version}.jar" />
	</target>
	
	<target name="compile" depends="parse_version">
		<mkdir dir="${compiled_dest}" />
		
		<echo message="Compiling to ${compiled_dest} using android lib ${android_lib} (using javac1.6)" />
		
		<javac srcdir="${basedir}/src"
			   excludes="**/sampleapp/" 
			   destdir="${compiled_dest}" 
			   bootclasspath="${android_lib}"
			   includeAntRuntime="false"
			   compiler="javac1.6"
		/>
				
		
	</target>
	
    <!-- TODO: run the base64 resource compilation script and inline resources -->
    <target name="compile_resources">
    	<echo message="Not implemented!" />
    </target>

	<!-- Create the default build.xml file and build.properties file for android -->
	<target name="configure">
		<echo>Creating android build.xml file</echo>
		
		<exec executable="${sdk.dir}/tools/android" dir="${basedir}">
			<arg value="update" />
			<arg value="project" />
			<arg value="--path" />
			<arg value="." />
		</exec>
	</target>
</project>
